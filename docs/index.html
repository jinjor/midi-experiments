<!DOCTYPE HTML>
<html>
<head>
  <meta charset="UTF-8">
  <title>Main</title>
  <style>html,head,body { padding:0; margin:0; }
    body { font-family: calibri, helvetica, arial, sans-serif; }
  </style>
  <script src="index.js"></script>
</head>
<body>
  <script>
    let outputs = {};
    let inputs = {};
    let app = Elm.Main.fullscreen();
    app.ports.send.subscribe(data => {
      let output = outputs[data.portId];
      if(output) {
        output.send(data.message);
      }
    });
    app.ports.requestMidiAccess.subscribe(() => {
      navigator.requestMIDIAccess()
        .then(midiAccess => {
          for(let output of midiAccess.outputs.values()) {
            outputs[output.id] = output;
          };
          for(let input of midiAccess.inputs.values()) {
            inputs[input.id] = input;
            input.onmidimessage = e => {
              var message = [];
              for (let i = 0; i < e.data.length; i++) {
                message.push(e.data[i]);
              }
              app.ports.receive.send({
                portId: input.id,
                message: message
              });
            }
          };
          // make ports objects immutable
          var midiAccess = {
            inputs: Object.keys(inputs).map(id => {
              var input = inputs[id];
              return {
                id: input.id,
                name: input.name
              };
            }),
            outputs: Object.keys(outputs).map(id => {
              var output = outputs[id];
              return {
                id: output.id,
                name: output.name
              };
            })
          }
          app.ports.receiveMidiAccess.send(midiAccess);
        }).catch(e => {
          console.log(e);
        });
    });
  </script>
</body>
